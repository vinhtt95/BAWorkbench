# UC-PM-04: Kiểm tra & Tái lập Chỉ mục (Validate & Re-index)

<table><tbody><tr><td>ID and Name:</td><td>UC-PM-04: Kiểm tra & Tái lập Chỉ mục (Validate & Re-index)</td><td>&nbsp;</td><td>&nbsp;</td></tr><tr><td>Created By:</td><td>&nbsp;</td><td>Date Created:</td><td>&nbsp;</td></tr><tr><td>Primary Actor:</td><td>Business Analyst (BA)</td><td>Secondary Actors:</td><td>Hệ thống</td></tr><tr><td>Description:</td><td colspan="3">Use case này cho phép BA chủ động kích hoạt một quy trình quét toàn bộ dự án để xây dựng lại Cơ sở dữ liệu Chỉ mục (<code>index.db</code>). Chức năng này dùng để sửa lỗi (ví dụ: sau khi BA thay đổi file thủ công bên ngoài, hoặc khôi phục file bằng Git) và đảm bảo tính toàn vẹn dữ liệu.</td></tr><tr><td>Trigger:</td><td colspan="3">BA chọn Menu "Dự án" > "Kiểm tra & Tái lập Chỉ mục".</td></tr><tr><td>Preconditions:</td><td colspan="3">BA đã mở một dự án (tham chiếu <code>UC-PM-02</code>).</td></tr><tr><td>Postconditions:</td><td colspan="3"><b>Thành công:</b> File <code>index.db</code> được cập nhật 100% đồng bộ (in-sync) với các file <code>.json</code> (Source of Truth) trên ổ đĩa. Mọi lỗi toàn vẹn (nếu có) được báo cáo.<br><b>Thất bại:</b> Quá trình quét bị lỗi (ví dụ: không đọc được file).</td></tr><tr><td>Normal Flow:</td><td colspan="3">1.0. BA kích hoạt (Trigger) use case.<br>2.0. Hệ thống hiển thị một thông báo "Đang quét và lập chỉ mục dự án. Vui lòng đợi..." (chạy trên luồng nền).<br>3.0. Hệ thống gọi <code>IndexService.validateAndRebuildIndex()</code>.<br>4.0. Hệ thống (Tự động hóa) thực hiện các bước sau:<br>    - 4.1. Khóa (Lock) cơ sở dữ liệu chỉ mục.<br>    - 4.2. Xóa sạch (Truncate) các bảng (ví dụ: <code>Artifacts</code>, <code>Links</code>).<br>    - 4.3. Quét (scan) đệ quy toàn bộ thư mục <code>/Artifacts/</code>.<br>    - 4.4. Với mỗi file <code>.json</code> tìm thấy: Đọc nội dung (ID, Name, Type, Status, Links...).<br>    - 4.5. Ghi (Insert) thông tin vào bảng <code>Artifacts</code> và <code>Links</code> trong <code>index.db</code>.<br>5.0. (Nếu quét thành công) Hệ thống hiển thị thông báo: "Hoàn tất. Đã lập chỉ mục cho [X] đối tượng và [Y] liên kết."<br>6.0. Hệ thống tự động làm mới (refresh) các View đang mở (ví dụ: Kanban, Graph View) để chúng đọc dữ liệu từ chỉ mục mới.</td></tr><tr><td>Alternative Flows:</td><td colspan="3"><b>1.0.A1: Tự động kích hoạt khi mở dự án</b><br>Tại <code>UC-PM-02</code> (Mở Dự án):<br>1.1. Hệ thống tự động kích hoạt Use Case này (<code>UC-PM-04</code>) ở chế độ nền (background) mà không cần BA nhấn nút.</td></tr><tr><td>Exceptions:</td><td colspan="3"><b>1.0.E1: Phát hiện file hỏng hoặc lỗi toàn vẹn</b><br>Tại bước 4.4:<br>4.1. Hệ thống tìm thấy một file <code>.json</code> bị hỏng (không thể đọc/parse).<br>4.2. Hoặc hệ thống tìm thấy một liên kết <code>@ID</code> (ví dụ: <code>@BR999</code>) trỏ đến một file <code>.json</code> không tồn tại (đã bị xóa thủ công).<br>4.3. Hệ thống vẫn tiếp tục quét và lập chỉ mục phần còn lại.<br>4.4. Tại bước 5.0, hệ thống hiển thị thông báo lỗi: "Hoàn tất. Đã lập chỉ mục... Tuy nhiên, đã phát hiện [Z] lỗi toàn vẹn. [Xem chi tiết]". (Ví dụ: "Liên kết <code>@BR999</code> trong <code>@UC001</code> bị hỏng").</td></tr><tr><td>Priority:</td><td colspan="3">Trung bình (Nhưng quan trọng cho tính toàn vẹn)</td></tr><tr><td>Frequency of Use:</td><td colspan="3">Thấp (Chỉ khi có sự cố hoặc sau khi đồng bộ Git)</td></tr><tr><td>Business Rules:</td><td colspan="3"><code>BR-INDEX-01</code>: File <code>.json</code> luôn là "Source of Truth". Chỉ mục (<code>index.db</code>) luôn phải được xây dựng lại từ <code>.json</code>, không bao giờ được làm ngược lại.</td></tr><tr><td>Other Information:</td><td colspan="3">Đây là "nút cứu hộ" (panic button) để đảm bảo hiệu suất và tính toàn vẹn của dự án.</td></tr><tr><td>Assumptions:</td><td colspan="3">Việc quét (scan) phải chạy trên luồng nền (background thread) để không "block" UI.</td></tr></tbody></table>

## Guideline

(Nội dung Guideline không thay đổi)